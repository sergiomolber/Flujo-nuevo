trigger:
- main

pool:
  vmImage: 'windows-latest'

steps:
- checkout: self
  displayName: 'Checkout repository'

- task: NodeTool@0
  inputs:
    versionSpec: '16.x'
  displayName: 'Install Node.js 16.x'

- script: |
    npm install -g newman
    npm install -g newman-reporter-allure
    npm install -g allure-commandline
    npm list -g --depth=0
  displayName: 'Install Newman and Allure'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo "Listing files in the sources directory after checkout:"
      Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse
  displayName: 'List Files in Sources Directory After Checkout'

- script: |
    mkdir callback\allure-results
    echo {\"name\":\"Callback\",\"type\":\"jenkins\",\"reportName\":\"Allure Report\"} > callback\allure-results\executor.json
  displayName: 'Setup Callback'

- script: |
    echo {\"Operating System\":\"Windows\",\"IDE\":\"Newman y Postman\",\"Environment\":\"CALLBACK\"} > callback\allure-results\environment.json
  displayName: 'Create Environment File Callback'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo "Listing files in the sources directory after setup:"
      Get-ChildItem -Path "$(Build.SourcesDirectory)" -Recurse
  displayName: 'List Files in Sources Directory After Setup'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo "Listing files in the global npm directory:"
      Get-ChildItem -Path "C:\Program Files\nodejs\node_modules\npm\node_modules" -Recurse
  displayName: 'List Files in Global npm Directory'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'
      $newmanPath = 'newman'
      if (Get-Command $newmanPath -ErrorAction SilentlyContinue) {
        & $newmanPath run "$(Build.SourcesDirectory)\callback\HappyPatchCallback.json" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\Callback_respuestas_200.json" -d "$(Build.ArtifactStagingDirectory)\Respuestas_200.csv" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\Callback_repuestas_401.json" -d "$(Build.ArtifactStagingDirectory)\Respuestas_401.csv" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\Callback_respuestas_400.json" -d "$(Build.ArtifactStagingDirectory)\Respuestas_400.csv" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\Callback_no_enviar_campos.json" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\CallbackError_500.json" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
        & $newmanPath run "$(Build.SourcesDirectory)\callback\CambioFormatoTxt.json" -g "$(Build.ArtifactStagingDirectory)\globals.json" -r allure --insecure
      } else {
        Write-Error "Newman not found. Make sure it's installed correctly."
      }
  displayName: 'Run Newman Tests'

- script: |
    allure generate --single-file callback\allure-results --clean -o callback\allure-report
    ren callback\allure-report\index.html callback_report.html
  displayName: 'Create Callback Report'

- script: |
    rmdir /S /Q AllureReports
    del AllureReports.zip
    mkdir AllureReports
    copy callback\allure-report\callback_report.html AllureReports\callback_report.html
    powershell Compress-Archive -Path AllureReports\* -DestinationPath AllureReports.zip
  displayName: 'Zip Reports'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\AllureReports.zip'
    ArtifactName: 'AllureReports'
  displayName: 'Publish Allure Reports'

- task: SendEmail@1
  inputs:
    subject: 'Resultado Microservicios Automatización Pago presente: flujo de fallos, anulación'
    body: 'Resultados de la ejecución del lanzamiento de los microservicios de transfiya'
    to: 'molinabernal@gmail.com'
    from: 'achjenkinsnewman@gmail.com'
    attachments: '$(Build.ArtifactStagingDirectory)\AllureReports.zip'
  displayName: 'Send Email with Allure Reports'
