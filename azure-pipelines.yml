trigger:
- main

pool:
  vmImage: 'windows-latest'

steps:
- script: |
    npm install -g newman
    npm install -g allure-commandline
  displayName: 'Install Newman and Allure'

- checkout: self
  displayName: 'Checkout repository'

- script: |
    echo "Listing files in the sources directory:"
    dir $(Build.SourcesDirectory) /s
  displayName: 'List Files in Sources Directory'



- script: |
    mkdir callback\allure-results
    echo {\"name\":\"Callback\",\"type\":\"jenkins\",\"reportName\":\"Allure Report\"} > callback\allure-results\executor.json
  displayName: 'Setup Callback'

- script: |
    mkdir management\allure-results
    echo {\"name\":\"Management\",\"type\":\"jenkins\",\"reportName\":\"Allure Report\"} > management\allure-results\executor.json
  displayName: 'Setup Management'

- script: |
    mkdir anulacion\allure-results
    echo {\"name\":\"Anulacion\",\"type\":\"jenkins\",\"reportName\":\"Allure Report\"} > anulacion\allure-results\executor.json
  displayName: 'Setup Anulacion'

- script: |
    echo {\"Operating System\":\"Windows\",\"IDE\":\"Newman y callbackman\",\"Environment\":\"CALLBACK\"} > callback\allure-results\environment.json
  displayName: 'Create Environment File Callback'

- script: |
    echo {\"Operating System\":\"Windows\",\"IDE\":\"Newman y callbackman\",\"Environment\":\"MANAGEMENT\"} > management\allure-results\environment.json
  displayName: 'Create Environment File Management'

- script: |
    echo {\"Operating System\":\"Windows\",\"IDE\":\"Newman y callbackman\",\"Environment\":\"ANULACION\"} > anulacion\allure-results\environment.json
  displayName: 'Create Environment File Anulacion'

- script: |
    copy $(Build.SourcesDirectory)\globals.json $(Build.ArtifactStagingDirectory)
    copy $(Build.SourcesDirectory)\Respuestas_200.csv $(Build.ArtifactStagingDirectory)
    copy $(Build.SourcesDirectory)\Respuestas_401.csv $(Build.ArtifactStagingDirectory)
    copy $(Build.SourcesDirectory)\Respuestas_400.csv $(Build.ArtifactStagingDirectory)
  displayName: 'Copy required files to staging directory'

- script: |
    echo "Listing files in the staging directory:"
    dir $(Build.ArtifactStagingDirectory) /s
  displayName: 'List Files in Staging Directory'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'
      $newmanPath = 'newman'
      if (Get-Command $newmanPath -ErrorAction SilentlyContinue) {
        & $newmanPath run HappyPatchCallback.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Callback_respuestas_200.json -d $(Build.ArtifactStagingDirectory)\Respuestas_200.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Callback_repuestas_401.json -d $(Build.ArtifactStagingDirectory)\Respuestas_401.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Callback_respuestas_400.json -d $(Build.ArtifactStagingDirectory)\Respuestas_400.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Callback_no_enviar_campos.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run CallbackError_500.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run CambioFormatoTxt.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
      } else {
        Write-Error "Newman not found. Make sure it's installed correctly."
      }
  displayName: 'Run Newman Tests Callback'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'
      $newmanPath = 'newman'
      if (Get-Command $newmanPath -ErrorAction SilentlyContinue) {
        & $newmanPath run Happy_Path.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Respuestas_Codigos_201.json -d $(Build.ArtifactStagingDirectory)\Respuestas_codigo_201.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Errores401.json -d $(Build.ArtifactStagingDirectory)\Errores401.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Errores_400_Codigo1013.json -d $(Build.ArtifactStagingDirectory)\Respuestas_codigo_400\(1013\).csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Errores_400_Codigo1018.json -d $(Build.ArtifactStagingDirectory)\Respuestas_codigo_400\(1018\).csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Errores400_sin_campos.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
      } else {
        Write-Error "Newman not found. Make sure it's installed correctly."
      }
  displayName: 'Run Newman Tests Management'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'
      $newmanPath = 'newman'
      if (Get-Command $newmanPath -ErrorAction SilentlyContinue) {
        & $newmanPath run anulacion_happypath.json -g $(Build.ArtifactStagingDirectory)\globals.json -e $(Build.ArtifactStagingDirectory)\environment.json -r allure --insecure
        & $newmanPath run Anulacion_401.json -d $(Build.ArtifactStagingDirectory)\Errores_401.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Anulacion_validar_mesageuid.json -d $(Build.ArtifactStagingDirectory)\Data_Messageuid.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Anulacion_transferid.json -d $(Build.ArtifactStagingDirectory)\Data_TransferId.csv -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run anulacion_cambio_ACCEPT.json -e $(Build.ArtifactStagingDirectory)\environment.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run anulacion_cambio_PENDING.json -e $(Build.ArtifactStagingDirectory)\environment.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run anulacion_estado_vacio.json -g $(Build.ArtifactStagingDirectory)\globals.json -e $(Build.ArtifactStagingDirectory)\environment.json -r allure --insecure
        & $newmanPath run Anulacion_sin_enviar.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Validar_respuestas.json -g $(Build.ArtifactStagingDirectory)\globals.json -r allure --insecure
        & $newmanPath run Anulacion_transferencia_ya_anulada.json -g $(Build.ArtifactStagingDirectory)\globals.json -e $(Build.ArtifactStagingDirectory)\environment.json -r allure --insecure
      } else {
        Write-Error "Newman not found. Make sure it's installed correctly."
      }
  displayName: 'Run Newman Tests Anulacion'

- script: |
    allure generate --single-file callback\allure-results --clean -o callback\allure-report
    ren callback\allure-report\index.html callback_report.html
  displayName: 'Create Callback Report'

- script: |
    allure generate --single-file management\allure-results --clean -o management\allure-report
    ren management\allure-report\index.html management_report.html
  displayName: 'Create Management Report'

- script: |
    allure generate --single-file anulacion\allure-results --clean -o anulacion\allure-report
    ren anulacion\allure-report\index.html anulacion_report.html
  displayName: 'Create Anulacion Report'

- script: |
    rmdir /S /Q AllureReports
    del AllureReports.zip
    mkdir AllureReports
    copy callback\allure-report\callback_report.html AllureReports\callback_report.html
    copy management\allure-report\management_report.html AllureReports\management_report.html
    copy anulacion\allure-report\anulacion_report.html AllureReports\anulacion_report.html
    powershell Compress-Archive -Path AllureReports\* -DestinationPath AllureReports.zip
  displayName: 'Zip Reports'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\AllureReports.zip'
    ArtifactName: 'AllureReports'
  displayName: 'Publish Allure Reports'

- task: SendEmail@1
  inputs:
    subject: 'Resultado Microservicios Automatización Pago presente: flujo de fallos, anulación'
    body: 'Resultados de la ejecución del lanzamiento de los microservicios de transfiya'
    to: 'molinabernal@gmail.com'
    from: 'achjenkinsnewman@gmail.com'
    attachments: '$(Build.ArtifactStagingDirectory)\AllureReports.zip'
  displayName: 'Send Email with Allure Reports'
